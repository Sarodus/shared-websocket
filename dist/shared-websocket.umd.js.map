{"version":3,"file":"shared-websocket.umd.js","sources":["../src/utils.ts","../src/shared-websocket.ts"],"sourcesContent":["export function uuidv4(): string {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        const r = (Math.random() * 16) | 0\n        const v = c === 'x' ? r : (r & 0x3) | 0x8\n        return v.toString(16)\n    })\n}\n","// Import here Polyfills if needed. Recommended core-js (npm i -D core-js)\n// import \"core-js/fn/array.find\"\n// ...\n\nimport { uuidv4 } from './utils'\n\ninterface SharedWebsocketMessageEvent extends MessageEvent {\n    isMaster: boolean\n}\n\nexport default class SharedWebsocket {\n    private _onclose: Function = () => undefined\n    private _onerror: Function = () => undefined\n    private _onmessage: Function = () => undefined\n    private _onopen: Function = () => undefined\n\n    private WEBSOCKET_COMMUNICATION_KEY = 'WEBSOCKET_COMMUNICATION_KEY'\n    private WEBSOCKET_MASTER_KEY = 'WEBSOCKET_MASTER_KEY'\n\n    private isMaster: boolean = false\n    private _isMasterAlive: boolean = false\n    private uuid: string\n    private _websocket: WebSocket | any\n    private destroyed = false\n\n    constructor(public url: string, public protocols?: string[]) {\n        this.uuid = uuidv4()\n        this.setEvents()\n        this.setUp()\n    }\n\n    send(data: any) {\n        if (this.destroyed) {\n            throw new Error('SharedWebsocket is closed')\n        } else if (this.isMaster) {\n            this._websocket.send(data)\n        } else {\n            const msg = {\n                type: 'send_websocket',\n                data\n            }\n            this.broadcast(msg)\n        }\n    }\n\n    close() {\n        this.destroyed = true\n        if (this.isMaster) {\n            this._websocket.close()\n        } else {\n            const msg = {\n                type: 'close_websocket'\n            }\n            this.broadcast(msg)\n        }\n    }\n\n    async setUp(): Promise<void> {\n        if (this.destroyed) {\n            throw new Error('SharedWebsocket is closed')\n        }\n        const isMasterAlive = await this.isMasterAlive()\n        if (isMasterAlive) {\n            return\n        }\n\n        localStorage.setItem('WANT_TO_BE_MASTER', this.uuid)\n        const iWillBeMaster = await new Promise(resolve =>\n            setTimeout(() => {\n                resolve(localStorage.getItem('WANT_TO_BE_MASTER') === this.uuid)\n            }, Math.random() * 100 + 100)\n        )\n        if (iWillBeMaster) {\n            return this.setMaster()\n        }\n        setTimeout(this.setUp.bind(this), 150)\n    }\n\n    setEvents() {\n        window.addEventListener('storage', this.handleStorageEvents.bind(this))\n        window.addEventListener('beforeunload', this.destroy.bind(this))\n    }\n\n    handleStorageEvents(event: any) {\n        if (!event.newValue) return\n        try {\n            switch (event.key) {\n                case this.WEBSOCKET_COMMUNICATION_KEY:\n                    this.handleCommunication(JSON.parse(event.newValue))\n                    break\n                default:\n                    break\n            }\n        } catch (error) {\n            console.log(error)\n        }\n    }\n\n    answerIsMasterAlive() {\n        const msg = {\n            type: 'answer_is_master_alive'\n        }\n        this.broadcast(msg)\n    }\n\n    handleCommunication(msg: object | any) {\n        switch (msg.type) {\n            case 'is_master_alive':\n                if (msg.uuid === this.uuid) {\n                    this.answerIsMasterAlive()\n                }\n                break\n\n            case 'answer_is_master_alive':\n                this._isMasterAlive = true\n                break\n\n            case 'send_websocket':\n                if (this.isMaster) {\n                    this._websocket.send(msg.data)\n                }\n                break\n\n            case 'close_websocket':\n                if (this.isMaster) {\n                    this._websocket.close()\n                }\n                break\n\n            case 'onclose':\n                if (!this.isMaster) {\n                    this.onclose()\n                }\n                break\n\n            case 'onopen':\n                if (!this.isMaster) {\n                    this.onopen()\n                }\n                break\n\n            case 'websocket_onmessage':\n                this._onmessage(msg.msg)\n                break\n\n            case 'master_left':\n                setTimeout(this.setUp.bind(this), 100)\n                break\n\n            default:\n                break\n        }\n    }\n\n    destroy() {\n        if (this.isMaster) {\n            this.isMaster = false\n            localStorage.removeItem(this.WEBSOCKET_MASTER_KEY)\n            const msg = {\n                type: 'master_left'\n            }\n            this.broadcast(msg)\n        }\n    }\n\n    broadcast(msg: object) {\n        localStorage.setItem(this.WEBSOCKET_COMMUNICATION_KEY, JSON.stringify(msg))\n        localStorage.removeItem(this.WEBSOCKET_COMMUNICATION_KEY)\n    }\n\n    async isMasterAlive(): Promise<boolean> {\n        this._isMasterAlive = false\n        return new Promise(async resolve => {\n            const currentMaster = localStorage.getItem(this.WEBSOCKET_MASTER_KEY)\n            const msg = {\n                type: 'is_master_alive',\n                uuid: currentMaster\n            }\n            this.broadcast(msg)\n            await new Promise(r => setTimeout(r, 100))\n            resolve(this._isMasterAlive)\n        })\n    }\n\n    setMaster(): void {\n        localStorage.setItem(this.WEBSOCKET_MASTER_KEY, this.uuid)\n        this.isMaster = true\n        this._websocket = new WebSocket(this.url, this.protocols)\n        this._websocket.onclose = this.onclose\n        this._websocket.onerror = this.onerror\n        this._websocket.onmessage = this.onmessage\n        this._websocket.onopen = this.onopen\n    }\n\n    get onclose(): Function {\n        return () => {\n            if (this.isMaster) {\n                this.destroy()\n                this.broadcast({ type: 'onclose' })\n            }\n            return this._onclose(this.isMaster)\n        }\n    }\n    set onclose(fn: Function) {\n        this._onclose = fn\n    }\n\n    get onerror(): Function {\n        return this._onerror\n    }\n    set onerror(fn: Function) {\n        this._onerror = fn\n    }\n\n    get onmessage(): Function {\n        return (msg: SharedWebsocketMessageEvent) => {\n            msg.isMaster = this.isMaster\n            this._onmessage(msg)\n            if (this.isMaster) {\n                this.broadcast({\n                    type: 'websocket_onmessage',\n                    msg: {\n                        data: msg.data,\n                        isMaster: false\n                    }\n                })\n            }\n        }\n    }\n    set onmessage(fn: Function) {\n        this._onmessage = fn\n    }\n\n    get onopen(): Function {\n        return () => {\n            if (this.isMaster) {\n                this.broadcast({ type: 'onopen' })\n            }\n            return this._onopen(this.isMaster)\n        }\n    }\n    set onopen(fn: Function) {\n        this._onopen = fn\n    }\n}\n\ndeclare global {\n    interface Window {\n        SharedWebsocket: any\n    }\n}\n\nwindow.SharedWebsocket = SharedWebsocket\n"],"names":[],"mappings":"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"}