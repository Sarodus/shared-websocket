{"version":3,"file":"shared-websocket.es5.js","sources":["../src/utils.ts","../src/shared-websocket.ts"],"sourcesContent":["export function uuidv4(): string {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        const r = (Math.random() * 16) | 0\n        const v = c === 'x' ? r : (r & 0x3) | 0x8\n        return v.toString(16)\n    })\n}\n","// Import here Polyfills if needed. Recommended core-js (npm i -D core-js)\n// import \"core-js/fn/array.find\"\n// ...\n\nimport { uuidv4 } from './utils'\n\ninterface SharedWebsocketMessageEvent extends MessageEvent {\n    isMaster: boolean\n}\n\nexport default class SharedWebsocket {\n    private _onclose: Function = () => undefined\n    private _onerror: Function = () => undefined\n    private _onmessage: Function = () => undefined\n    private _onopen: Function = () => undefined\n\n    private WEBSOCKET_COMMUNICATION_KEY = 'WEBSOCKET_COMMUNICATION_KEY'\n    private WEBSOCKET_MASTER_KEY = 'WEBSOCKET_MASTER_KEY'\n\n    private isMaster: boolean = false\n    private _isMasterAlive: boolean = false\n    private uuid: string\n    private _websocket: WebSocket | any\n    private destroyed = false\n\n    // fight for master\n    private alone: boolean = true\n\n    constructor(public url: string, public protocols?: string[]) {\n        this.uuid = uuidv4()\n        this.setEvents()\n        this.setUp()\n    }\n\n    send(data: any) {\n        if (this.destroyed) {\n            throw new Error('SharedWebsocket is closed')\n        } else if (this.isMaster) {\n            this._websocket.send(data)\n        } else {\n            const msg = {\n                type: 'send_websocket',\n                data\n            }\n            this.broadcast(msg)\n        }\n    }\n\n    close() {\n        this.destroyed = true\n        if (this.isMaster) {\n            this._websocket.close()\n        } else {\n            const msg = {\n                type: 'close_websocket'\n            }\n            this.broadcast(msg)\n        }\n    }\n\n    async setUp(): Promise<void> {\n        if (this.destroyed) {\n            throw new Error('SharedWebsocket is closed')\n        }\n        const isMasterAlive = await this.isMasterAlive()\n        if (isMasterAlive) {\n            return\n        }\n\n        let iWillBeMaster = await this.fightToBeMaster()\n\n        if (iWillBeMaster) {\n            return this.setMaster()\n        }\n    }\n\n    async fightToBeMaster(): Promise<boolean> {\n        localStorage.setItem('WANT_TO_BE_MASTER', this.uuid)\n        let willYou = true\n        let firstRun = true\n\n        while (!this.alone || firstRun) {\n            firstRun = false\n            willYou = willYou && await new Promise(resolve =>\n                setTimeout(() => {\n                    const who = localStorage.getItem('WANT_TO_BE_MASTER')\n                    resolve(who === this.uuid)\n                }, 50)\n            )\n            if (willYou) {\n                this.alone = true\n                this.broadcast({\n                    type: 'want_to_be_master'\n                })\n                await new Promise(resolve => setTimeout(resolve, 150))\n            } else {\n                break\n            }\n        }\n        return willYou\n    }\n\n    setEvents() {\n        window.addEventListener('storage', this.handleStorageEvents.bind(this))\n        window.addEventListener('beforeunload', this.destroy.bind(this))\n    }\n\n    handleStorageEvents(event: any) {\n        if (!event.newValue) return\n        try {\n            switch (event.key) {\n                case this.WEBSOCKET_COMMUNICATION_KEY:\n                    this.handleCommunication(JSON.parse(event.newValue))\n                    break\n                default:\n                    break\n            }\n        } catch (error) {\n            console.log(error)\n        }\n    }\n\n    answerIsMasterAlive() {\n        const msg = {\n            type: 'answer_is_master_alive'\n        }\n        this.broadcast(msg)\n    }\n\n    handleCommunication(msg: object | any) {\n        switch (msg.type) {\n            case 'is_master_alive':\n                if (msg.uuid === this.uuid) {\n                    this.answerIsMasterAlive()\n                }\n                break\n\n            case 'answer_is_master_alive':\n                this._isMasterAlive = true\n                break\n\n            case 'send_websocket':\n                if (this.isMaster) {\n                    this._websocket.send(msg.data)\n                }\n                break\n\n            case 'close_websocket':\n                if (this.isMaster) {\n                    this._websocket.close()\n                }\n                break\n\n            case 'onclose':\n                if (!this.isMaster) {\n                    this.onclose()\n                }\n                break\n\n            case 'onopen':\n                if (!this.isMaster) {\n                    this.onopen()\n                }\n                break\n\n            case 'websocket_onmessage':\n                this._onmessage(msg.msg)\n                break\n\n            case 'want_to_be_master':\n                this.alone = false\n                break\n\n            case 'master_left':\n                setTimeout(this.setUp.bind(this), 100)\n                break\n\n            default:\n                break\n        }\n    }\n\n    destroy() {\n        if (this.isMaster) {\n            this.isMaster = false\n            localStorage.removeItem(this.WEBSOCKET_MASTER_KEY)\n            const msg = {\n                type: 'master_left'\n            }\n            this.broadcast(msg)\n        }\n    }\n\n    broadcast(msg: object) {\n        localStorage.setItem(this.WEBSOCKET_COMMUNICATION_KEY, JSON.stringify(msg))\n        localStorage.removeItem(this.WEBSOCKET_COMMUNICATION_KEY)\n    }\n\n    async isMasterAlive(): Promise<boolean> {\n        this._isMasterAlive = false\n        return new Promise(async resolve => {\n            const currentMaster = localStorage.getItem(this.WEBSOCKET_MASTER_KEY)\n            const msg = {\n                type: 'is_master_alive',\n                uuid: currentMaster\n            }\n            this.broadcast(msg)\n            await new Promise(r => setTimeout(r, 150))\n            resolve(this._isMasterAlive)\n        })\n    }\n\n    setMaster(): void {\n        localStorage.setItem(this.WEBSOCKET_MASTER_KEY, this.uuid)\n        this.isMaster = true\n        this._websocket = new WebSocket(this.url, this.protocols)\n        this._websocket.onclose = this.onclose\n        this._websocket.onerror = this.onerror\n        this._websocket.onmessage = this.onmessage\n        this._websocket.onopen = this.onopen\n    }\n\n    get onclose(): Function {\n        return () => {\n            if (this.isMaster) {\n                this.destroy()\n                this.broadcast({ type: 'onclose' })\n            }\n            return this._onclose(this.isMaster)\n        }\n    }\n    set onclose(fn: Function) {\n        this._onclose = fn\n    }\n\n    get onerror(): Function {\n        return this._onerror\n    }\n    set onerror(fn: Function) {\n        this._onerror = fn\n    }\n\n    get onmessage(): Function {\n        return (msg: SharedWebsocketMessageEvent) => {\n            msg.isMaster = this.isMaster\n            this._onmessage(msg)\n            if (this.isMaster) {\n                this.broadcast({\n                    type: 'websocket_onmessage',\n                    msg: {\n                        data: msg.data,\n                        isMaster: false\n                    }\n                })\n            }\n        }\n    }\n    set onmessage(fn: Function) {\n        this._onmessage = fn\n    }\n\n    get onopen(): Function {\n        return () => {\n            if (this.isMaster) {\n                this.broadcast({ type: 'onopen' })\n            }\n            return this._onopen(this.isMaster)\n        }\n    }\n    set onopen(fn: Function) {\n        this._onopen = fn\n    }\n}\n\ndeclare global {\n    interface Window {\n        SharedWebsocket: any\n    }\n}\n\nwindow.SharedWebsocket = SharedWebsocket\n"],"names":[],"mappings":"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"}